<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corrade Configuration - RadegastWeb</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        .corrade-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .section {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .group-item {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            background: var(--input-bg);
        }
        
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .group-uuid {
            font-family: monospace;
            font-size: 0.9em;
            color: var(--text-muted);
        }
        
        .permissions {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .permission-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            align-items: end;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-color);
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-enabled {
            background: #28a745;
        }
        
        .status-disabled {
            background: #dc3545;
        }
        
        .test-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
        }
        
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .test-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .test-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="corrade-container">
        <h1>Corrade Plugin Configuration</h1>
        
        <!-- Status Section -->
        <div class="section">
            <h2>Status</h2>
            <div id="status-display">
                <span class="status-indicator status-disabled"></span>
                <span>Loading...</span>
            </div>
        </div>
        
        <!-- Groups Configuration -->
        <div class="section">
            <h2>Groups Configuration</h2>
            <div id="groups-list">
                <!-- Groups will be loaded here -->
            </div>
            
            <!-- Add New Group Form -->
            <h3>Add New Group</h3>
            <form id="add-group-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="groupUuid">Group UUID</label>
                        <input type="text" id="groupUuid" required placeholder="00000000-0000-0000-0000-000000000000">
                    </div>
                    <div class="form-group">
                        <label for="groupPassword">Password</label>
                        <input type="password" id="groupPassword" required placeholder="Enter password">
                    </div>
                    <div class="form-group">
                        <label for="groupName">Group Name (Optional)</label>
                        <input type="text" id="groupName" placeholder="Display name">
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">Add Group</button>
                    </div>
                </div>
                
                <div class="permissions">
                    <div class="permission-item">
                        <input type="checkbox" id="allowLocalChat" checked>
                        <label for="allowLocalChat">Allow Local Chat</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="allowGroupRelay" checked>
                        <label for="allowGroupRelay">Allow Group Relay</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="allowAvatarIM" checked>
                        <label for="allowAvatarIM">Allow Avatar IM</label>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Command Tester -->
        <div class="section">
            <h2>Command Tester</h2>
            <div class="test-section">
                <p>Test Corrade commands without executing them:</p>
                <div class="form-row">
                    <div class="form-group" style="flex: 3;">
                        <label for="testCommand">Command</label>
                        <input type="text" id="testCommand" placeholder='command=tell&group=GROUP_UUID&password=PASSWORD&entity=local&message=Hello World'>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-success" onclick="testCommand()">Test Command</button>
                    </div>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Examples:</strong>
                    <button type="button" class="btn btn-primary" style="margin: 2px; padding: 4px 8px; font-size: 12px;" onclick="insertExampleCommand('local')">Local Chat</button>
                    <button type="button" class="btn btn-primary" style="margin: 2px; padding: 4px 8px; font-size: 12px;" onclick="insertExampleCommand('group')">My Group</button>
                    <button type="button" class="btn btn-primary" style="margin: 2px; padding: 4px 8px; font-size: 12px;" onclick="insertExampleCommand('groupTarget')">Other Group</button>
                    <button type="button" class="btn btn-primary" style="margin: 2px; padding: 4px 8px; font-size: 12px;" onclick="insertExampleCommand('avatar')">Avatar IM</button>
                </div>
                <div id="test-result"></div>
            </div>
        </div>
    </div>

    <script>
        // API configuration
        const API_BASE = '/api/corrade';
        
        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadStatus();
            loadGroups();
        });
        
        // Load status
        async function loadStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const status = await response.json();
                
                const statusElement = document.getElementById('status-display');
                const indicator = status.isEnabled ? 'status-enabled' : 'status-disabled';
                const text = status.isEnabled ? 
                    `Enabled (${status.groupCount} groups configured)` : 
                    'Disabled (no groups configured)';
                
                statusElement.innerHTML = `
                    <span class="status-indicator ${indicator}"></span>
                    <span>${text}</span>
                `;
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }
        
        // Load groups
        async function loadGroups() {
            try {
                const response = await fetch(`${API_BASE}/config`);
                const config = await response.json();
                
                const groupsList = document.getElementById('groups-list');
                
                if (config.groups.length === 0) {
                    groupsList.innerHTML = '<p>No groups configured.</p>';
                    return;
                }
                
                groupsList.innerHTML = config.groups.map(group => `
                    <div class="group-item">
                        <div class="group-header">
                            <div>
                                <strong>${group.groupName || 'Unnamed Group'}</strong>
                                <div class="group-uuid">${group.groupUuid}</div>
                            </div>
                            <button class="btn btn-danger" onclick="removeGroup('${group.groupUuid}')">Remove</button>
                        </div>
                        <div class="permissions">
                            <div class="permission-item">
                                <input type="checkbox" ${group.allowLocalChat ? 'checked' : ''} disabled>
                                <label>Local Chat</label>
                            </div>
                            <div class="permission-item">
                                <input type="checkbox" ${group.allowGroupRelay ? 'checked' : ''} disabled>
                                <label>Group Relay</label>
                            </div>
                            <div class="permission-item">
                                <input type="checkbox" ${group.allowAvatarIM ? 'checked' : ''} disabled>
                                <label>Avatar IM</label>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }
        
        // Add group form handler
        document.getElementById('add-group-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const groupData = {
                groupUuid: document.getElementById('groupUuid').value,
                password: document.getElementById('groupPassword').value,
                groupName: document.getElementById('groupName').value || null,
                allowLocalChat: document.getElementById('allowLocalChat').checked,
                allowGroupRelay: document.getElementById('allowGroupRelay').checked,
                allowAvatarIM: document.getElementById('allowAvatarIM').checked
            };
            
            try {
                const response = await fetch(`${API_BASE}/config/groups`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(groupData)
                });
                
                if (response.ok) {
                    // Clear form
                    document.getElementById('add-group-form').reset();
                    document.getElementById('allowLocalChat').checked = true;
                    document.getElementById('allowGroupRelay').checked = true;
                    document.getElementById('allowAvatarIM').checked = true;
                    
                    // Reload data
                    loadStatus();
                    loadGroups();
                    
                    alert('Group added successfully!');
                } else {
                    const error = await response.text();
                    alert(`Error adding group: ${error}`);
                }
            } catch (error) {
                console.error('Error adding group:', error);
                alert('Error adding group. Please try again.');
            }
        });
        
        // Remove group
        async function removeGroup(groupUuid) {
            if (!confirm('Are you sure you want to remove this group?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/config/groups/${encodeURIComponent(groupUuid)}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadStatus();
                    loadGroups();
                    alert('Group removed successfully!');
                } else {
                    const error = await response.text();
                    alert(`Error removing group: ${error}`);
                }
            } catch (error) {
                console.error('Error removing group:', error);
                alert('Error removing group. Please try again.');
            }
        }
        
        // Test command
        async function testCommand() {
            const command = document.getElementById('testCommand').value;
            if (!command) {
                alert('Please enter a command to test.');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/test-command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: command })
                });
                
                const result = await response.json();
                const resultElement = document.getElementById('test-result');
                
                const statusClass = result.success ? 'test-success' : 'test-error';
                const statusText = result.success ? 'SUCCESS' : 'ERROR';
                
                resultElement.innerHTML = `
                    <div class="test-result ${statusClass}">
                        <strong>${statusText}:</strong> ${result.message}
                        ${result.errorCode ? `<br><strong>Error Code:</strong> ${result.errorCode}` : ''}
                    </div>
                `;
            } catch (error) {
                console.error('Error testing command:', error);
                document.getElementById('test-result').innerHTML = `
                    <div class="test-result test-error">
                        <strong>ERROR:</strong> Failed to test command. Please try again.
                    </div>
                `;
            }
        }
        
        // Add some example commands
        function insertExampleCommand(type) {
            const examples = {
                local: 'command=tell&group=GROUP_UUID&password=PASSWORD&entity=local&message=Hello local chat!',
                group: 'command=tell&group=GROUP_UUID&password=PASSWORD&entity=group&message=Hello my group!',
                groupTarget: 'command=tell&group=GROUP_UUID&password=PASSWORD&entity=group&target=TARGET_GROUP_UUID&message=Hello other group!',
                avatar: 'command=tell&group=GROUP_UUID&password=PASSWORD&entity=avatar&target=AVATAR_UUID&message=Hello avatar!'
            };
            
            document.getElementById('testCommand').value = examples[type] || examples.local;
        }
    </script>
</body>
</html>