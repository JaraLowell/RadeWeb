<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radegast Web - Multi-Account Second Life Client</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/region-info.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid main-content">
        <header class="bg-primary text-white p-3 mb-4">
            <div class="row align-items-center">
                <div class="col">
                    <h1><i class="fas fa-globe me-2"></i>Radegast Web 1.2ÃŸ</h1>
                    <p class="mb-0">
                        Multi-Account Second Life Web Client
                    </p>
                </div>
                <div class="col-auto">
                    <a href="stats.html" target="_blank" rel="noopener noreferrer" class="btn btn-outline-light me-2" title="Visitor Statistics">
                        <i class="fas fa-chart-bar me-1"></i>Statistics
                    </a>
                    <button id="darkModeToggle" class="btn btn-outline-light me-2" title="Toggle dark mode">
                        <i id="darkModeIcon" class="fas fa-moon"></i>
                    </button>
                    <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                        <i class="fas fa-plus me-1"></i>Add Account
                    </button>
                </div>
            </div>
        </header>

        <div class="row content-row">
            <!-- Accounts Sidebar -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-users me-2"></i>Accounts</h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="accountsList" class="list-group list-group-flush">
                            <!-- Accounts will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="col-md-6 chat-column">
                <div id="welcomeMessage" class="text-center py-5">
                    <i class="fas fa-robot fa-3x text-muted mb-3"></i>
                    <h3>Welcome to Radegast Web</h3>
                    <img src="img/radegast.jpg" alt="Radegast" class="img-fluid rounded" style="width: 90%; border: 2px solid black; margin-top: 20px;">
                    <br><br>
                    <p class="text-muted">Add an account or select one to get started with your Second Life experience.</p>
                </div>

                <!-- Account Chat Interface (hidden by default) -->
                <div id="chatInterface" class="d-none">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h5 id="chatAccountName" class="mb-0"></h5>
                                <small id="chatAccountStatus" class="text-muted"></small>
                            </div>
                            <div>
                                <button id="regionInfoBtn" class="btn btn-info btn-sm me-2 d-none" title="Region Information">
                                    <i class="fas fa-globe me-1"></i>Region Info
                                </button>
                                <button id="loginBtn" class="btn btn-success btn-sm me-2">
                                    <i class="fas fa-sign-in-alt me-1"></i>Login
                                </button>
                                <button id="logoutBtn" class="btn btn-danger btn-sm">
                                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <!-- Chat Tabs -->
                            <ul class="nav nav-tabs" id="chatTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="local-chat-tab" type="button" role="tab">
                                        <i class="fas fa-comments me-1"></i>Local Chat
                                        <span class="badge bg-secondary ms-1" id="local-chat-count">0</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="im-tabs-dropdown" data-bs-toggle="dropdown" type="button">
                                        <i class="fas fa-envelope me-1"></i>IMs
                                        <span class="badge bg-info ms-1" id="total-im-count">0</span>
                                        <i class="fas fa-caret-down ms-1"></i>
                                    </button>
                                    <ul class="dropdown-menu" id="imTabsList">
                                        <!-- IM tabs will be added here dynamically -->
                                    </ul>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="group-tabs-dropdown" data-bs-toggle="dropdown" type="button">
                                        <i class="fas fa-users me-1"></i>Groups
                                        <span class="badge bg-success ms-1" id="total-group-count">0</span>
                                        <i class="fas fa-caret-down ms-1"></i>
                                    </button>
                                    <ul class="dropdown-menu" id="groupTabsList">
                                        <!-- Group tabs will be added here dynamically -->
                                    </ul>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="notices-tab" type="button" role="tab">
                                        <i class="fas fa-bell me-1"></i>Notices
                                        <span class="badge bg-warning ms-1" id="total-notices-count">0</span>
                                    </button>
                                </li>
                            </ul>

                            <!-- Chat Monitoring Indicator -->
                            <div id="chatMonitoringIndicator" class="chat-monitoring-indicator p-2 border-bottom text-center">
                                <small class="text-muted"><i class="fas fa-eye me-1"></i>Monitoring Local Chat</small>
                            </div>

                            <!-- Tab Content -->
                            <div class="tab-content" id="chatTabContent">
                                <!-- Local Chat Tab -->
                                <div class="tab-pane fade show active" id="local-chat" role="tabpanel">
                                    <div class="chat-messages" id="localChatMessages">
                                        <!-- Local chat messages will appear here -->
                                    </div>
                                    <div class="chat-input-area p-3 border-top">
                                        <div class="input-group">
                                            <select id="localChatType" class="form-select" style="max-width: 120px;">
                                                <option value="Normal">Normal</option>
                                                <option value="Whisper">Whisper</option>
                                                <option value="Shout">Shout</option>
                                            </select>
                                            <input type="text" id="localChatInput" class="form-control" placeholder="Type your message...">
                                            <button id="sendLocalChatBtn" class="btn btn-primary" type="button">
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Notices Tab -->
                                <div class="tab-pane fade" id="notices" role="tabpanel">
                                    <div class="chat-messages" id="noticesMessages">
                                        <!-- Notices will appear here -->
                                    </div>
                                    <div class="chat-input-area p-3 border-top text-center">
                                        <small class="text-muted">Notices from groups and system messages</small>
                                    </div>
                                </div>

                                <!-- IM Tabs will be added here dynamically -->
                                <!-- Group Tabs will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar - People List -->
            <div class="col-md-3">
                <div id="peoplePanel" class="d-none">
                    <!-- People Nearby Panel -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-eye me-2"></i>People Nearby</h6>
                            <button id="radarToggleBtn" class="btn btn-sm btn-outline-secondary" type="button" title="Toggle Radar Stats">
                                <i id="radarToggleIcon" class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div id="peopleList" class="people-list">
                                <!-- People in region will appear here -->
                            </div>
                            <div id="radarStats" class="p-2 border-top text-muted" style="display: none;">
                                <!-- Radar statistics will appear here -->
                            </div>
                        </div>
                    </div>

                    <!-- Mini Map and Region Info -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6><i class="fas fa-map me-2"></i>Region Map</h6>
                        </div>
                        <div class="card-body">
                            <div id="regionInfo">
                                <div class="text-muted text-center">
                                    <i class="fas fa-map-marker-alt fa-2x mb-2"></i>
                                    <p class="small">Connect to see region details</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Groups Panel -->
                    <div class="card mt-3" id="groupsPanel">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-users me-2"></i>Groups <span id="groupCount" class="badge bg-secondary">0</span></h6>
                            <button id="groupsToggleBtn" class="btn btn-sm btn-outline-secondary" type="button" title="Toggle Groups List">
                                <i id="groupsToggleIcon" class="fas fa-chevron-up"></i>
                            </button>
                        </div>
                        <div class="card-body p-0" id="groupsCardBody">
                            <div id="groupsList" class="list-group list-group-flush">
                                <!-- Groups will appear here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Movement Controls -->
                    <div class="card mt-3" id="movementControls" style="display: none;">
                        <div class="card-header">
                            <h6><i class="fas fa-chair me-1"></i>Sitting Controls</h6>
                        </div>
                        <div class="card-body">
                            <!-- Sit/Stand Controls -->
                            <div class="mb-3">
                                <div class="input-group mb-2">
                                    <input type="text" id="objectIdInput" class="form-control" placeholder="Object UUID (optional)" style="font-size: 0.85rem;">
                                    <button id="validateObjectBtn" class="btn btn-outline-info btn-sm" title="Check if object exists">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <div class="d-grid gap-2">
                                    <button id="sitBtn" class="btn btn-primary btn-sm">
                                        <i class="fas fa-chair me-1"></i>Sit
                                    </button>
                                    <button id="standBtn" class="btn btn-secondary btn-sm">
                                        <i class="fas fa-walking me-1"></i>Stand
                                    </button>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">Leave UUID empty to sit on ground</small>
                                </div>
                            </div>
                            
                            <!-- Auto-Sit Controls -->
                            <div class="border-top pt-2 mb-3">
                                <h6 class="small text-muted mb-2">
                                    <i class="fas fa-sync-alt me-1"></i>Auto-Sit
                                </h6>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="autoSitEnabled">
                                    <label class="form-check-label" for="autoSitEnabled">
                                        <small>Auto-sit on last object after login</small>
                                    </label>
                                </div>
                                <div class="row g-2" id="autoSitSettings" style="display: none;">
                                    <div class="col-12">
                                        <div class="mb-2">
                                            <small class="text-muted">Delay (seconds):</small>
                                            <input type="number" id="autoSitDelay" class="form-control form-control-sm" value="180" min="30" max="600">
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="autoSitRestorePresence" checked>
                                            <label class="form-check-label" for="autoSitRestorePresence">
                                                <small>Restore Away/Busy status when reseating</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <button id="autoSitResitBtn" class="btn btn-outline-primary btn-sm w-100" title="Resit on last object now">
                                            <i class="fas fa-redo me-1"></i>Resit Now
                                        </button>
                                    </div>
                                    <div class="col-12">
                                        <div class="mt-1">
                                            <small class="text-muted">Last target: <span id="autoSitLastTarget">None</span></small>
                                        </div>
                                        <div class="mt-1">
                                            <small class="text-muted">Last status: <span id="autoSitLastStatus">Online</span></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Manual Presence Controls -->
                            <div class="border-top pt-2 mb-3">
                                <h6 class="small text-muted mb-2">
                                    <i class="fas fa-user-clock me-1"></i>Presence Status
                                </h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <button id="setAwayBtn" class="btn btn-outline-warning btn-sm w-100" data-status="away">
                                            <i class="fas fa-clock me-1"></i><span id="awayBtnText">Set Away</span>
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button id="setBusyBtn" class="btn btn-outline-danger btn-sm w-100" data-status="busy">
                                            <i class="fas fa-do-not-disturb me-1"></i><span id="busyBtnText">Set Busy</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="row g-2 mt-1" style="display: none;">
                                    <div class="col-12">
                                        <button id="setOnlineBtn" class="btn btn-outline-success btn-sm w-100">
                                            <i class="fas fa-user me-1"></i>Set Online
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Current Status -->
                            <div class="border-top pt-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Status:</small>
                                    <span id="currentPresenceStatus" class="text-muted">Online</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Sitting:</small>
                                    <span id="sittingStatus" class="badge bg-secondary">Standing</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-1">
                                    <small class="text-muted">On Object:</small>
                                    <small id="sittingObjectInfo" class="text-muted">None</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br><br>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div class="modal fade" id="addAccountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addAccountForm">
                        <div class="mb-3">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="firstName" required>
                        </div>
                        <div class="mb-3">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="lastName" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="mb-3">
                            <label for="displayName" class="form-label">Display Name (Optional)</label>
                            <input type="text" class="form-control" id="displayName">
                        </div>
                        <div class="mb-3">
                            <label for="relayUuid" class="form-label">Relay UUID (Optional)</label>
                            <input type="text" class="form-control" id="relayUuid" placeholder="00000000-0000-0000-0000-000000000000">
                            <div class="form-text">Avatar UUID for relay functionality - leave empty if not needed</div>
                        </div>
                        <div class="mb-3">
                            <label for="gridUrl" class="form-label">Grid URL</label>
                            <select class="form-select" id="gridUrl">
                                <option value="https://login.agni.lindenlab.com/cgi-bin/login.cgi">Second Life (Main Grid)</option>
                                <option value="https://login.aditi.lindenlab.com/cgi-bin/login.cgi">Second Life Beta (Aditi)</option>
                                <option value="custom">Custom Grid...</option>
                            </select>
                        </div>
                        <div class="mb-3 d-none" id="customGridDiv">
                            <label for="customGridUrl" class="form-label">Custom Grid URL</label>
                            <input type="url" class="form-control" id="customGridUrl">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveAccountBtn">Save Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Account Modal -->
    <div class="modal fade" id="editAccountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editAccountForm">
                        <input type="hidden" id="editAccountId">
                        <div class="mb-3">
                            <label for="editFirstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="editFirstName" readonly>
                            <div class="form-text">Avatar name cannot be changed</div>
                        </div>
                        <div class="mb-3">
                            <label for="editLastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="editLastName" readonly>
                            <div class="form-text">Avatar name cannot be changed</div>
                        </div>
                        <div class="mb-3">
                            <label for="editPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="editPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="editDisplayName" class="form-label">Display Name (Optional)</label>
                            <input type="text" class="form-control" id="editDisplayName">
                        </div>
                        <div class="mb-3">
                            <label for="editRelayUuid" class="form-label">Relay UUID (Optional)</label>
                            <input type="text" class="form-control" id="editRelayUuid" placeholder="00000000-0000-0000-0000-000000000000">
                            <div class="form-text">Avatar UUID for relay functionality - leave empty if not needed</div>
                        </div>
                        <div class="mb-3">
                            <label for="editGridUrl" class="form-label">Grid URL</label>
                            <select class="form-select" id="editGridUrl" disabled>
                                <option value="https://login.agni.lindenlab.com/cgi-bin/login.cgi">Second Life (Main Grid)</option>
                                <option value="https://login.aditi.lindenlab.com/cgi-bin/login.cgi">Second Life Beta (Aditi)</option>
                                <option value="custom">Custom Grid...</option>
                            </select>
                            <div class="form-text">Grid cannot be changed</div>
                        </div>
                        <div class="mb-3 d-none" id="editCustomGridDiv">
                            <label for="editCustomGridUrl" class="form-label">Custom Grid URL</label>
                            <input type="url" class="form-control" id="editCustomGridUrl" readonly>
                            <div class="form-text">Grid cannot be changed</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateAccountBtn">Update Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script Dialog Modal -->
    <div class="modal fade" id="scriptDialogModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-code me-2"></i>
                        <span id="scriptDialogObjectName">Object</span>
                    </h5>
                    <small class="text-muted ms-2" id="scriptDialogOwnerName"></small>
                </div>
                <div class="modal-body">
                    <div id="scriptDialogMessage" class="mb-3"></div>
                    
                    <!-- Text input for llTextBox dialogs -->
                    <div id="scriptTextInputDiv" class="mb-3 d-none">
                        <label for="scriptTextInput" class="form-label">Enter your response:</label>
                        <input type="text" id="scriptTextInput" class="form-control" maxlength="1023" placeholder="Type your response here...">
                        <div class="form-text">Maximum 1023 characters</div>
                    </div>
                    
                    <!-- Buttons container for choice dialogs -->
                    <div id="scriptDialogButtons" class="d-grid gap-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="scriptDialogIgnore">
                        <i class="fas fa-times me-1"></i>Ignore
                    </button>
                    <button type="button" class="btn btn-primary d-none" id="scriptDialogSend">
                        <i class="fas fa-paper-plane me-1"></i>Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script Permission Modal -->
    <div class="modal fade" id="scriptPermissionModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">
                        <i class="fas fa-shield-alt me-2"></i>Script Permission Request
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong id="permissionObjectName">Object</strong> owned by <strong id="permissionObjectOwner">Owner</strong> 
                        is requesting permission to:
                    </div>
                    <div id="permissionDescription" class="mb-3"></div>
                    <div class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i>
                        Only grant permissions to objects you trust. These permissions can affect your avatar and inventory.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" id="scriptPermissionMute">
                        <i class="fas fa-volume-mute me-1"></i>Mute Object
                    </button>
                    <button type="button" class="btn btn-danger" id="scriptPermissionDeny">
                        <i class="fas fa-times me-1"></i>Deny
                    </button>
                    <button type="button" class="btn btn-success" id="scriptPermissionGrant">
                        <i class="fas fa-check me-1"></i>Grant
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Interactive Notice Modal -->
    <div class="modal fade" id="interactiveNoticeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i id="interactiveNoticeIcon" class="fas fa-user-friends me-2"></i>
                        <span id="interactiveNoticeTitle">Interactive Notice</span>
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong id="interactiveNoticeFromName">Someone</strong> 
                        <span id="interactiveNoticeMessage">has sent you a request.</span>
                    </div>
                    <div id="interactiveNoticeDetails" class="mb-3"></div>
                    <div class="text-muted small">
                        <i class="fas fa-clock me-1"></i>
                        <span id="interactiveNoticeTime">--:--</span>
                        <span id="interactiveNoticeExpiry" class="ms-3 d-none">
                            <i class="fas fa-hourglass-half me-1"></i>
                            Expires: <span id="interactiveNoticeExpiryTime">--:--</span>
                        </span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="interactiveNoticeDecline">
                        <i class="fas fa-times me-1"></i>Decline
                    </button>
                    <button type="button" class="btn btn-success" id="interactiveNoticeAccept">
                        <i class="fas fa-check me-1"></i>Accept
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="d-none position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background: rgba(0,0,0,0.5); z-index: 9999;">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Footer -->
    <footer style="background-color: #4a73a9; color: white; text-align: right; padding: 5px; margin-top: auto;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <small>&nbsp;&nbsp;<i class="fas fa-clock me-1"></i>SL Time: <span id="slTime">--:--</span></small>
            </div>
            <div>
                <p class="mb-0">Created by <a target="_blank" rel="noopener noreferrer" href="https://github.com/JaraLowell/RadeWeb">Jara Lowell</a> and <a target="_blank" rel="noopener noreferrer" href="https://github.com/cinderblocks/radegast">Radegast Metaverse Client</a>&nbsp;&nbsp;</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <script>
        // Dynamic height calculation for chat interface
        function calculateChatHeight() {
            const header = document.querySelector('header');
            const footer = document.querySelector('footer');
            const chatInterface = document.getElementById('chatInterface');
            const chatCard = chatInterface ? chatInterface.querySelector('.card') : null;
            const chatHeader = chatCard ? chatCard.querySelector('.card-header') : null;
            const chatTabs = document.getElementById('chatTabs');
            const chatInputArea = document.querySelector('.chat-input-area');
            const chatMonitoring = document.getElementById('chatMonitoringIndicator');
            
            if (!chatInterface || chatInterface.classList.contains('d-none')) {
                return; // Don't calculate if chat interface is hidden
            }
            
            // Get viewport height
            const viewportHeight = window.innerHeight;
            
            // Calculate heights of fixed elements
            const headerHeight = header ? header.offsetHeight : 0;
            const footerHeight = footer ? footer.offsetHeight : 0;
            const chatHeaderHeight = chatHeader ? chatHeader.offsetHeight : 0;
            const chatTabsHeight = chatTabs ? chatTabs.offsetHeight : 0;
            const chatInputHeight = chatInputArea ? chatInputArea.offsetHeight : 0;
            const chatMonitoringHeight = chatMonitoring ? chatMonitoring.offsetHeight : 0;
            
            // Add some padding/margin space (approximation)
            const spacing = 60; // Account for margins, paddings, borders
            
            // Calculate available height for chat messages within the constrained layout
            const maxContentHeight = viewportHeight - headerHeight - footerHeight - 20; // 20px for minimal spacing
            const availableHeight = maxContentHeight - chatHeaderHeight - chatTabsHeight - chatInputHeight - chatMonitoringHeight - spacing;
            
            // Set the height for all chat message containers to fill available space
            const chatMessages = document.querySelectorAll('.chat-messages');
            chatMessages.forEach(container => {
                const finalHeight = Math.max(300, availableHeight); // Min 300px to fill space better
                container.style.height = finalHeight + 'px';
                container.style.maxHeight = finalHeight + 'px';
            });
            
            console.log('Chat height calculated:', {
                viewport: viewportHeight,
                header: headerHeight,
                footer: footerHeight,
                chatHeader: chatHeaderHeight,
                chatTabs: chatTabsHeight,
                chatInput: chatInputHeight,
                monitoring: chatMonitoringHeight,
                spacing: spacing,
                maxContent: maxContentHeight,
                available: availableHeight,
                final: Math.max(200, Math.min(availableHeight, 500))
            });
        }
        
        // Initial calculation when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for all elements to be rendered
            setTimeout(calculateChatHeight, 100);
        });
        
        // Recalculate on window resize
        window.addEventListener('resize', calculateChatHeight);
        
        // Recalculate when chat interface becomes visible
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    const chatInterface = document.getElementById('chatInterface');
                    if (chatInterface && !chatInterface.classList.contains('d-none')) {
                        setTimeout(calculateChatHeight, 100);
                    }
                }
            });
        });
        
        // Start observing the chat interface for class changes
        document.addEventListener('DOMContentLoaded', function() {
            const chatInterface = document.getElementById('chatInterface');
            if (chatInterface) {
                observer.observe(chatInterface, { attributes: true });
            }
        });

        // SL Time Display (Pacific Time)
        function updateSLTime() {
            try {
                const now = new Date();
                // Convert to Pacific Time using proper timezone handling
                const slTime = new Intl.DateTimeFormat('en-US', {
                    timeZone: 'America/Los_Angeles',
                    timeZoneName: "short",
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                }).format(now);
                
                const slTimeElement = document.getElementById('slTime');
                if (slTimeElement) {
                    slTimeElement.textContent = slTime;
                }
            } catch (error) {
                console.error('Error updating SL time:', error);
                const slTimeElement = document.getElementById('slTime');
                if (slTimeElement) {
                    slTimeElement.textContent = '--:--';
                }
            }
        }

        // Update SL time immediately and then every minute
        document.addEventListener('DOMContentLoaded', function() {
            updateSLTime();
            setInterval(updateSLTime, 15000); // Update every 15 seconds
        });
    </script>
    <script src="/js/auth.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/region-info.js"></script>
    <script src="/js/minimap.js"></script>
</body>
</html>